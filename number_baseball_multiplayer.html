<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Number Baseball">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Play Number Baseball with friends or solo!">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest_multiplayer.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon-192.png">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4YCRZYFNX4"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-4YCRZYFNX4');
    </script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <title>ğŸ® Number Baseball</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 30px;
            position: relative;
        }

        .version {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 11px;
            color: rgba(102, 126, 234, 0.6);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* ì–¸ì–´ ì„ íƒ */
        .language-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .lang-btn {
            flex: 1;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 16px;
        }

        .lang-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .lang-btn .flag {
            font-size: 40px;
            margin-bottom: 10px;
        }

        /* ëª¨ë“œ ì„ íƒ */
        .mode-selector {
            display: none;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .mode-btn-solo {
            grid-column: 1 / -1;
        }

        .mode-btn {
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .mode-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .mode-btn .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .mode-btn .title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .mode-btn .desc {
            font-size: 12px;
            color: #666;
        }

        .room-section {
            display: none;
        }

        .room-code-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .room-code {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 8px;
            margin: 10px 0;
        }

        .copy-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            letter-spacing: 8px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
            margin-top: 10px;
        }

        .players-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 3px solid transparent;
        }

        .player-card.me {
            border-color: #667eea;
        }

        .player-card.opponent {
            border-color: #e74c3c;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .player-attempts {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .player-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .game-area {
            display: none;
        }

        .game-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .attempts {
            font-size: 18px;
            color: #333;
            font-weight: bold;
        }

        .history {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .history-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }

        .guess-number {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            letter-spacing: 5px;
        }

        .result {
            font-size: 18px;
            font-weight: bold;
            padding: 5px 15px;
            border-radius: 20px;
            background: #667eea;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 350px;
            width: 90%;
        }

        .modal-title {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .modal-text {
            font-size: 20px;
            color: #333;
            margin-bottom: 10px;
        }

        .modal-detail {
            color: #666;
            margin: 20px 0;
            white-space: pre-line;
        }

        .waiting-text {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 14px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            .room-code {
                font-size: 28px;
                letter-spacing: 5px;
            }

            .players-status {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="version">v2.3 (Multi+Solo)</div>
        <h1 id="mainTitle">ğŸ® Number Baseball</h1>
        <p class="subtitle" id="mainSubtitle">Choose your language</p>

        <!-- ì–¸ì–´ ì„ íƒ -->
        <div id="languageSelector" class="language-selector">
            <div class="lang-btn" onclick="setLanguage('ko')">
                <div class="flag">ğŸ‡°ğŸ‡·</div>
                <div>í•œêµ­ì–´</div>
            </div>
            <div class="lang-btn" onclick="setLanguage('en')">
                <div class="flag">ğŸ‡ºğŸ‡¸</div>
                <div>English</div>
            </div>
        </div>

        <!-- ëª¨ë“œ ì„ íƒ -->
        <div id="modeSelector" class="mode-selector">
            <div class="mode-grid">
                <div class="mode-btn" onclick="showGameModeSelection('create')">
                    <div class="icon">ğŸ </div>
                    <div class="title" id="createRoomTitle">ë°© ë§Œë“¤ê¸°</div>
                    <div class="desc" id="createRoomDesc">ì¹œêµ¬ë¥¼ ì´ˆëŒ€í•˜ì„¸ìš”</div>
                </div>
                <div class="mode-btn" onclick="showJoinRoom()">
                    <div class="icon">ğŸšª</div>
                    <div class="title" id="joinRoomTitle">ë°© ì…ì¥</div>
                    <div class="desc" id="joinRoomDesc">ì½”ë“œë¡œ ì…ì¥í•˜ê¸°</div>
                </div>
            </div>
            <div class="mode-btn mode-btn-solo" onclick="startSoloMode()">
                <div class="icon">ğŸ¯</div>
                <div class="title" id="soloModeTitle">í˜¼ìí•˜ê¸°</div>
                <div class="desc" id="soloModeDesc">í˜¼ìì„œ ì—°ìŠµí•˜ê¸°</div>
            </div>
        </div>

        <!-- ê²Œì„ ë°©ì‹ ì„ íƒ -->
        <div id="gameModeSelection" class="room-section">
            <h3 style="text-align: center; margin-bottom: 20px;" id="gameModeTitle">ê²Œì„ ë°©ì‹ ì„ íƒ</h3>
            <div class="mode-grid">
                <div class="mode-btn" onclick="createRoom('simultaneous')">
                    <div class="icon">âš¡</div>
                    <div class="title" id="simultaneousTitle">ë™ì‹œ ëŒ€ê²°</div>
                    <div class="desc" id="simultaneousDesc">ëˆ„ê°€ ë¨¼ì € ë§ì¶”ë‚˜!</div>
                </div>
                <div class="mode-btn" onclick="createRoom('turn-based')">
                    <div class="icon">ğŸ”„</div>
                    <div class="title" id="turnBasedTitle">í„´ì œ ëŒ€ê²°</div>
                    <div class="desc" id="turnBasedDesc">ë²ˆê°ˆì•„ê°€ë©° ì¶”ì¸¡</div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="backToMode()" id="backBtn3">ëŒì•„ê°€ê¸°</button>
        </div>

        <!-- ë°© ì…ì¥ -->
        <div id="joinSection" class="room-section">
            <h3 style="text-align: center; margin-bottom: 20px;" id="joinTitle">ë°© ì½”ë“œ ì…ë ¥</h3>
            <div class="input-group">
                <input type="text" id="roomCodeInput" placeholder="ABC123" maxlength="6" style="text-transform: uppercase;">
            </div>
            <button class="btn btn-primary" onclick="joinRoom()" id="joinBtn">ì…ì¥í•˜ê¸°</button>
            <button class="btn btn-secondary" onclick="backToMode()" id="backBtn1">ëŒì•„ê°€ê¸°</button>
        </div>

        <!-- ëŒ€ê¸°ì‹¤ -->
        <div id="waitingRoom" class="room-section">
            <div class="room-code-display">
                <div style="font-size: 14px; color: #666;" id="roomCodeLabel">ë°© ì½”ë“œ</div>
                <div class="room-code" id="displayRoomCode"></div>
                <div style="font-size: 12px; color: #999; margin-bottom: 10px;" id="shareText">ì´ ì½”ë“œë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”!</div>
                <button class="copy-btn" onclick="copyRoomCode()" id="copyBtn">ğŸ“‹ ì½”ë“œ ë³µì‚¬</button>
                <button class="copy-btn" onclick="shareRoomCode()" style="margin-left: 10px;" id="shareBtn">ğŸ“¤ ë©”ì‹œì§€ë¡œ ê³µìœ </button>
            </div>

            <div class="waiting-text">
                <div class="spinner"></div>
                <div style="margin-top: 10px;" id="waitingText">ì¹œêµ¬ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
            </div>

            <button class="btn btn-secondary" onclick="leaveRoom()" id="leaveBtn1">ë‚˜ê°€ê¸°</button>
        </div>

        <!-- ë©€í‹°í”Œë ˆì´ì–´ ê²Œì„ í™”ë©´ -->
        <div id="multiplayerGame" class="game-area">
            <div id="turnInfo" style="text-align: center; padding: 10px; margin-bottom: 15px; background: #f8f9fa; border-radius: 10px; font-weight: bold; color: #667eea; display: none;">
                <span id="turnText">ë‹¹ì‹  ì°¨ë¡€ì…ë‹ˆë‹¤!</span>
            </div>

            <div class="players-status">
                <div class="player-card me">
                    <div class="player-name" id="meLabel">ğŸ”µ ë‚˜</div>
                    <div class="player-attempts"><span id="myAttempts">0</span><span id="attemptsUnit1">íšŒ</span></div>
                    <div class="player-status" id="myStatus">í”Œë ˆì´ ì¤‘...</div>
                </div>
                <div class="player-card opponent">
                    <div class="player-name" id="opponentLabel">ğŸ”´ ìƒëŒ€ë°©</div>
                    <div class="player-attempts"><span id="opponentAttempts">0</span><span id="attemptsUnit2">íšŒ</span></div>
                    <div class="player-status" id="opponentStatus">í”Œë ˆì´ ì¤‘...</div>
                </div>
            </div>

            <div class="input-group">
                <input type="tel" id="guessInputMulti" maxlength="3" placeholder="000" autocomplete="off">
            </div>
            <button class="btn btn-primary" onclick="makeGuessMulti()" id="guessBtn1">ì¶”ì¸¡í•˜ê¸°</button>

            <div class="history" id="historyMulti"></div>

            <button class="btn btn-secondary" onclick="leaveRoom()" id="leaveBtn2">ê²Œì„ ë‚˜ê°€ê¸°</button>
        </div>

        <!-- í˜¼ìí•˜ê¸° ê²Œì„ í™”ë©´ -->
        <div id="soloGame" class="game-area">
            <div class="game-info">
                <div class="attempts"><span id="soloAttemptsLabel">ì‹œë„: </span><span id="attemptCount">0</span> / 30</div>
            </div>

            <div class="input-group">
                <input type="tel" id="guessInputSolo" maxlength="3" placeholder="000" autocomplete="off">
            </div>
            <button class="btn btn-primary" onclick="makeGuessSolo()" id="guessBtn2">ì¶”ì¸¡í•˜ê¸°</button>

            <div class="history" id="historySolo"></div>

            <button class="btn btn-secondary" onclick="newSoloGame()" id="newGameBtn">ìƒˆ ê²Œì„</button>
            <button class="btn btn-secondary" onclick="backToMode()" id="backBtn2">ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <!-- ìŠ¹ë¦¬/íŒ¨ë°° ëª¨ë‹¬ -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <div class="modal-title" id="resultEmoji">ğŸ‰</div>
            <div class="modal-text" id="resultText">ìŠ¹ë¦¬!</div>
            <div class="modal-detail" id="resultDetail"></div>
            <div id="multiplayerButtons" style="display: none;">
                <button class="btn btn-primary" onclick="playAgain()" id="playAgainBtn" style="margin-bottom: 10px;">ìƒˆ ê²Œì„</button>
                <button class="btn btn-secondary" onclick="closeModal()" id="closeModalBtn2">ë‚˜ê°€ê¸°</button>
            </div>
            <div id="soloButton">
                <button class="btn btn-primary" onclick="closeModal()" id="closeModalBtn">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // ì–¸ì–´ ë°ì´í„°
        const translations = {
            ko: {
                mainTitle: "ğŸ® ìˆ«ìì•¼êµ¬",
                mainSubtitle: "ê²Œì„ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”",
                createRoomTitle: "ë°© ë§Œë“¤ê¸°",
                createRoomDesc: "ì¹œêµ¬ë¥¼ ì´ˆëŒ€í•˜ì„¸ìš”",
                joinRoomTitle: "ë°© ì…ì¥",
                joinRoomDesc: "ì½”ë“œë¡œ ì…ì¥í•˜ê¸°",
                soloModeTitle: "í˜¼ìí•˜ê¸°",
                soloModeDesc: "í˜¼ìì„œ ì—°ìŠµí•˜ê¸°",
                gameModeTitle: "ê²Œì„ ë°©ì‹ ì„ íƒ",
                simultaneousTitle: "ë™ì‹œ ëŒ€ê²°",
                simultaneousDesc: "ëˆ„ê°€ ë¨¼ì € ë§ì¶”ë‚˜!",
                turnBasedTitle: "í„´ì œ ëŒ€ê²°",
                turnBasedDesc: "ë²ˆê°ˆì•„ê°€ë©° ì¶”ì¸¡",
                joinTitle: "ë°© ì½”ë“œ ì…ë ¥",
                joinBtn: "ì…ì¥í•˜ê¸°",
                backBtn: "ëŒì•„ê°€ê¸°",
                roomCodeLabel: "ë°© ì½”ë“œ",
                shareText: "ì´ ì½”ë“œë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”!",
                copyBtn: "ğŸ“‹ ì½”ë“œ ë³µì‚¬",
                shareBtn: "ğŸ“¤ ë©”ì‹œì§€ë¡œ ê³µìœ ",
                waitingText: "ì¹œêµ¬ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...",
                leaveBtn: "ë‚˜ê°€ê¸°",
                meLabel: "ğŸ”µ ë‚˜",
                opponentLabel: "ğŸ”´ ìƒëŒ€ë°©",
                attemptsUnit: "íšŒ",
                myStatusPlaying: "í”Œë ˆì´ ì¤‘...",
                opponentStatusPlaying: "í”Œë ˆì´ ì¤‘...",
                myStatusWin: "ğŸ† ìŠ¹ë¦¬!",
                opponentStatusWin: "ğŸ† ìŠ¹ë¦¬!",
                guessBtn: "ì¶”ì¸¡í•˜ê¸°",
                soloAttemptsLabel: "ì‹œë„: ",
                newGameBtn: "ìƒˆ ê²Œì„",
                playAgainBtn: "ìƒˆ ê²Œì„",
                yourTurn: "ë‹¹ì‹  ì°¨ë¡€ì…ë‹ˆë‹¤!",
                opponentTurn: "ìƒëŒ€ë°© ì°¨ë¡€ì…ë‹ˆë‹¤...",
                waitingForOpponent: "ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...",
                winTitle: "ìŠ¹ë¦¬!",
                winDetail: "{attempts}ë²ˆ ë§Œì— ë§ì¶”ì…¨ìŠµë‹ˆë‹¤!",
                loseTitle: "íŒ¨ë°°...",
                loseDetail: "ìƒëŒ€ë°©ì´ {attempts}ë²ˆ ë§Œì— ë§ì·„ìŠµë‹ˆë‹¤.",
                soloWinTitle: "ì¶•í•˜í•©ë‹ˆë‹¤!",
                soloWinDetail: "{attempts}ë²ˆ ë§Œì— ë§ì¶”ì…¨ìŠµë‹ˆë‹¤!\nì •ë‹µ: {answer}",
                soloLoseTitle: "ì•„ì‰½ë„¤ìš”!",
                soloLoseDetail: "30ë²ˆ ì‹œë„í–ˆì§€ë§Œ ë§ì¶”ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\nì •ë‹µ: {answer}",
                closeModalBtn: "í™•ì¸",
                closeModalBtn2: "ë‚˜ê°€ê¸°",
                errorDigits: "âš ï¸ 3ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”",
                errorRepeating: "âš ï¸ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”",
                errorNotYourTurn: "âš ï¸ ìƒëŒ€ë°© ì°¨ë¡€ì…ë‹ˆë‹¤!",
                errorRoomCode: "6ìë¦¬ ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”",
                errorNoRoom: "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤",
                errorStarted: "ì´ë¯¸ ì‹œì‘ëœ ê²Œì„ì…ë‹ˆë‹¤",
                codeCopied: "ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ",
                shareMessage: "ìˆ«ìì•¼êµ¬ ê²Œì„ì— ì´ˆëŒ€í•©ë‹ˆë‹¤!\në°© ì½”ë“œ: {code}\n\në§í¬ë¡œ ë°”ë¡œ ì…ì¥í•˜ê¸°:\n{url}?room={code}"
            },
            en: {
                mainTitle: "ğŸ® Number Baseball",
                mainSubtitle: "Choose game mode",
                createRoomTitle: "Create Room",
                createRoomDesc: "Invite friends",
                joinRoomTitle: "Join Room",
                joinRoomDesc: "Enter room code",
                soloModeTitle: "Solo Play",
                soloModeDesc: "Practice alone",
                gameModeTitle: "Choose Game Mode",
                simultaneousTitle: "Simultaneous",
                simultaneousDesc: "Race to finish!",
                turnBasedTitle: "Turn-based",
                turnBasedDesc: "Take turns guessing",
                joinTitle: "Enter Room Code",
                joinBtn: "Join",
                backBtn: "Back",
                roomCodeLabel: "Room Code",
                shareText: "Share this code with friends!",
                copyBtn: "ğŸ“‹ Copy Code",
                shareBtn: "ğŸ“¤ Share via Message",
                waitingText: "Waiting for friend...",
                leaveBtn: "Leave",
                meLabel: "ğŸ”µ Me",
                opponentLabel: "ğŸ”´ Opponent",
                attemptsUnit: " attempts",
                myStatusPlaying: "Playing...",
                opponentStatusPlaying: "Playing...",
                myStatusWin: "ğŸ† Win!",
                opponentStatusWin: "ğŸ† Win!",
                guessBtn: "Submit",
                soloAttemptsLabel: "Attempts: ",
                newGameBtn: "New Game",
                playAgainBtn: "Play Again",
                yourTurn: "Your turn!",
                opponentTurn: "Opponent's turn...",
                waitingForOpponent: "Waiting for opponent...",
                winTitle: "Victory!",
                winDetail: "You got it in {attempts} attempts!",
                loseTitle: "Defeat...",
                loseDetail: "Opponent got it in {attempts} attempts.",
                soloWinTitle: "Congratulations!",
                soloWinDetail: "You got it in {attempts} attempts!\nAnswer: {answer}",
                soloLoseTitle: "Game Over!",
                soloLoseDetail: "You've used all 30 attempts.\nAnswer: {answer}",
                closeModalBtn: "OK",
                closeModalBtn2: "Leave",
                errorDigits: "âš ï¸ Please enter a 3-digit number",
                errorRepeating: "âš ï¸ Please enter non-repeating digits",
                errorNotYourTurn: "âš ï¸ Wait for your turn!",
                errorRoomCode: "Please enter a 6-digit room code",
                errorNoRoom: "Room does not exist",
                errorStarted: "Game already started",
                codeCopied: "Code copied: ",
                shareMessage: "Join my Number Baseball game!\nRoom Code: {code}\n\nDirect link:\n{url}?room={code}"
            }
        };

        let currentLang = 'ko';

        function setLanguage(lang) {
            currentLang = lang;
            updateTexts();
            document.getElementById('languageSelector').style.display = 'none';
            document.getElementById('modeSelector').style.display = 'block';
        }

        function updateTexts() {
            const t = translations[currentLang];
            document.getElementById('mainTitle').textContent = t.mainTitle;
            document.getElementById('mainSubtitle').textContent = t.mainSubtitle;
            document.getElementById('createRoomTitle').textContent = t.createRoomTitle;
            document.getElementById('createRoomDesc').textContent = t.createRoomDesc;
            document.getElementById('joinRoomTitle').textContent = t.joinRoomTitle;
            document.getElementById('joinRoomDesc').textContent = t.joinRoomDesc;
            document.getElementById('soloModeTitle').textContent = t.soloModeTitle;
            document.getElementById('soloModeDesc').textContent = t.soloModeDesc;
            document.getElementById('gameModeTitle').textContent = t.gameModeTitle;
            document.getElementById('simultaneousTitle').textContent = t.simultaneousTitle;
            document.getElementById('simultaneousDesc').textContent = t.simultaneousDesc;
            document.getElementById('turnBasedTitle').textContent = t.turnBasedTitle;
            document.getElementById('turnBasedDesc').textContent = t.turnBasedDesc;
            document.getElementById('joinTitle').textContent = t.joinTitle;
            document.getElementById('joinBtn').textContent = t.joinBtn;
            document.getElementById('backBtn1').textContent = t.backBtn;
            document.getElementById('backBtn2').textContent = t.backBtn;
            document.getElementById('backBtn3').textContent = t.backBtn;
            document.getElementById('roomCodeLabel').textContent = t.roomCodeLabel;
            document.getElementById('shareText').textContent = t.shareText;
            document.getElementById('copyBtn').textContent = t.copyBtn;
            document.getElementById('shareBtn').textContent = t.shareBtn;
            document.getElementById('waitingText').textContent = t.waitingText;
            document.getElementById('leaveBtn1').textContent = t.leaveBtn;
            document.getElementById('leaveBtn2').textContent = t.leaveBtn;
            document.getElementById('meLabel').textContent = t.meLabel;
            document.getElementById('opponentLabel').textContent = t.opponentLabel;
            document.getElementById('attemptsUnit1').textContent = t.attemptsUnit;
            document.getElementById('attemptsUnit2').textContent = t.attemptsUnit;
            document.getElementById('myStatus').textContent = t.myStatusPlaying;
            document.getElementById('opponentStatus').textContent = t.opponentStatusPlaying;
            document.getElementById('guessBtn1').textContent = t.guessBtn;
            document.getElementById('guessBtn2').textContent = t.guessBtn;
            document.getElementById('soloAttemptsLabel').textContent = t.soloAttemptsLabel;
            document.getElementById('newGameBtn').textContent = t.newGameBtn;
            document.getElementById('playAgainBtn').textContent = t.playAgainBtn;
            document.getElementById('closeModalBtn').textContent = t.closeModalBtn;
            document.getElementById('closeModalBtn2').textContent = t.closeModalBtn2;
        }

        function getText(key, replacements = {}) {
            let text = translations[currentLang][key];
            for (let [k, v] of Object.entries(replacements)) {
                text = text.replace(`{${k}}`, v);
            }
            return text;
        }

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCZqGq1dGKCZESJcqOcNlwwGtWrHld2R3k",
            authDomain: "number-baseball-28392.firebaseapp.com",
            databaseURL: "https://number-baseball-28392-default-rtdb.firebaseio.com",
            projectId: "number-baseball-28392",
            storageBucket: "number-baseball-28392.firebasestorage.app",
            messagingSenderId: "613478280450",
            appId: "1:613478280450:web:211ebe0e64570f4e66e61b",
            measurementId: "G-K7Y19FJ5N7"
        };

        // Firebase ì´ˆê¸°í™”
        let app, database;
        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase ì´ˆê¸°í™” ì„±ê³µ!');
        } catch (error) {
            console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
        }

        let roomCode = '';
        let playerId = 'player' + Date.now();
        let isHost = false;
        let answer = '';
        let attempts = 0;
        let gameEnded = false;
        let gameMode = ''; // 'multiplayer' or 'solo'
        let multiplayerMode = ''; // 'simultaneous' or 'turn-based'
        let currentTurn = '';
        let opponentId = '';

        function generateNumber() {
            const digits = [];
            while (digits.length < 3) {
                const digit = Math.floor(Math.random() * 10);
                if (!digits.includes(digit)) {
                    digits.push(digit);
                }
            }
            return digits.join('');
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // ===== í˜¼ìí•˜ê¸° ëª¨ë“œ =====
        function startSoloMode() {
            gameMode = 'solo';
            answer = generateNumber();
            attempts = 0;
            gameEnded = false;

            hideAllSections();
            document.getElementById('soloGame').style.display = 'block';
            document.getElementById('attemptCount').textContent = '0';
            document.getElementById('historySolo').innerHTML = '';
            document.getElementById('guessInputSolo').value = '';
            document.getElementById('guessInputSolo').focus();
        }

        function makeGuessSolo() {
            if (gameEnded) return;

            const input = document.getElementById('guessInputSolo');
            const guess = input.value.trim();

            if (guess.length !== 3 || !/^\d{3}$/.test(guess)) {
                alert(getText('errorDigits'));
                return;
            }

            if (new Set(guess).size !== 3) {
                alert(getText('errorRepeating'));
                return;
            }

            attempts++;
            document.getElementById('attemptCount').textContent = attempts;

            const result = calculateResult(answer, guess);
            const resultStr = formatResult(result.strike, result.ball);

            addHistorySolo(guess, resultStr);

            if (result.strike === 3) {
                gameEnded = true;
                setTimeout(() => {
                    showSoloResult(true);
                }, 500);
            } else if (attempts >= 30) {
                gameEnded = true;
                setTimeout(() => {
                    showSoloResult(false);
                }, 500);
            }

            input.value = '';
            input.focus();
        }

        function addHistorySolo(guess, result) {
            const historyEl = document.getElementById('historySolo');
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <span class="guess-number">${guess}</span>
                <span class="result">${result}</span>
            `;
            historyEl.insertBefore(item, historyEl.firstChild);
        }

        function showSoloResult(won) {
            const modal = document.getElementById('resultModal');
            const emoji = document.getElementById('resultEmoji');
            const text = document.getElementById('resultText');
            const detail = document.getElementById('resultDetail');

            if (won) {
                emoji.textContent = 'ğŸ‰';
                text.textContent = getText('soloWinTitle');
                detail.textContent = getText('soloWinDetail', { attempts: attempts, answer: answer });
            } else {
                emoji.textContent = 'ğŸ˜¢';
                text.textContent = getText('soloLoseTitle');
                detail.textContent = getText('soloLoseDetail', { answer: answer });
            }

            modal.classList.add('show');
        }

        function newSoloGame() {
            startSoloMode();
        }

        // ===== ê²Œì„ ëª¨ë“œ ì„ íƒ =====
        function showGameModeSelection(action) {
            hideAllSections();
            document.getElementById('gameModeSelection').style.display = 'block';
        }

        // ===== ë©€í‹°í”Œë ˆì´ì–´ ëª¨ë“œ =====
        function createRoom(mode) {
            gameMode = 'multiplayer';
            multiplayerMode = mode;
            roomCode = generateRoomCode();
            isHost = true;
            answer = generateNumber();
            gameEnded = false;
            attempts = 0;

            const roomRef = database.ref('rooms/' + roomCode);
            const roomData = {
                answer: answer,
                host: playerId,
                status: 'waiting',
                gameMode: mode,
                players: {
                    [playerId]: {
                        attempts: 0,
                        status: 'waiting',
                        isWinner: false
                    }
                },
                createdAt: Date.now()
            };

            if (mode === 'turn-based') {
                roomData.currentTurn = playerId;
                roomData.turnOrder = [playerId];
            }

            roomRef.set(roomData);

            showWaitingRoom();
            listenToRoom();
        }

        function showJoinRoom() {
            hideAllSections();
            document.getElementById('joinSection').style.display = 'block';
        }

        function joinRoom() {
            const input = document.getElementById('roomCodeInput').value.toUpperCase();
            if (input.length !== 6) {
                alert(getText('errorRoomCode'));
                return;
            }

            gameMode = 'multiplayer';
            roomCode = input;
            gameEnded = false;
            attempts = 0;
            const roomRef = database.ref('rooms/' + roomCode);
            
            roomRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    alert(getText('errorNoRoom'));
                    return;
                }

                const roomData = snapshot.val();
                if (roomData.status !== 'waiting') {
                    alert(getText('errorStarted'));
                    return;
                }

                answer = roomData.answer;
                multiplayerMode = roomData.gameMode || 'simultaneous';
                
                roomRef.child('players/' + playerId).set({
                    attempts: 0,
                    status: 'ready',
                    isWinner: false
                });

                // í„´ì œ ëª¨ë“œì¼ ê²½ìš° turnOrderì— ì¶”ê°€
                if (multiplayerMode === 'turn-based') {
                    roomRef.child('turnOrder').once('value').then(orderSnapshot => {
                        const turnOrder = orderSnapshot.val() || [];
                        turnOrder.push(playerId);
                        roomRef.update({ turnOrder: turnOrder });
                    });
                }

                roomRef.update({ status: 'playing' });

                showMultiplayerGame();
                listenToRoom();
            });
        }

        function showWaitingRoom() {
            hideAllSections();
            document.getElementById('waitingRoom').style.display = 'block';
            document.getElementById('displayRoomCode').textContent = roomCode;
        }

        function showMultiplayerGame() {
            hideAllSections();
            document.getElementById('multiplayerGame').style.display = 'block';
            document.getElementById('myAttempts').textContent = '0';
            document.getElementById('opponentAttempts').textContent = '0';
            document.getElementById('historyMulti').innerHTML = '';
            document.getElementById('guessInputMulti').value = '';
            
            if (multiplayerMode === 'turn-based') {
                updateTurnDisplay();
            }
            
            document.getElementById('guessInputMulti').focus();
        }

        function listenToRoom() {
            const roomRef = database.ref('rooms/' + roomCode);
            
            roomRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                // ê²Œì„ ëª¨ë“œ ì €ì¥
                if (data.gameMode) {
                    multiplayerMode = data.gameMode;
                }

                // í„´ì œ ëª¨ë“œì¼ ê²½ìš° í˜„ì¬ í„´ ì €ì¥
                if (multiplayerMode === 'turn-based' && data.currentTurn) {
                    currentTurn = data.currentTurn;
                    updateTurnDisplay();
                }

                if (data.status === 'playing' && document.getElementById('waitingRoom').style.display === 'block') {
                    showMultiplayerGame();
                }

                updatePlayerStatus(data.players);
            });
        }

        function updatePlayerStatus(players) {
            let myData = null;
            let opponentData = null;

            for (let pid in players) {
                if (pid === playerId) {
                    myData = players[pid];
                } else {
                    opponentData = players[pid];
                    opponentId = pid; // ìƒëŒ€ë°© ID ì €ì¥
                }
            }

            if (myData) {
                document.getElementById('myAttempts').textContent = myData.attempts;
                if (myData.isWinner) {
                    document.getElementById('myStatus').textContent = getText('myStatusWin');
                    if (!gameEnded) {
                        gameEnded = true;
                        showMultiResult(true, myData.attempts, opponentData?.attempts || 0);
                    }
                }
            }

            if (opponentData) {
                document.getElementById('opponentAttempts').textContent = opponentData.attempts;
                if (opponentData.isWinner) {
                    document.getElementById('opponentStatus').textContent = getText('opponentStatusWin');
                    if (!gameEnded) {
                        gameEnded = true;
                        showMultiResult(false, myData.attempts, opponentData.attempts);
                    }
                }
            }
        }

        function calculateResult(answer, guess) {
            let strike = 0;
            let ball = 0;

            for (let i = 0; i < 3; i++) {
                if (guess[i] === answer[i]) {
                    strike++;
                } else if (answer.includes(guess[i])) {
                    ball++;
                }
            }

            return { strike, ball };
        }

        function formatResult(strike, ball) {
            if (strike === 0 && ball === 0) return '0';
            const parts = [];
            if (strike > 0) parts.push(`${strike}S`);
            if (ball > 0) parts.push(`${ball}B`);
            return parts.join(' ');
        }

        function updateTurnDisplay() {
            const turnInfo = document.getElementById('turnInfo');
            const turnText = document.getElementById('turnText');
            const guessBtn = document.getElementById('guessBtn1');
            const guessInput = document.getElementById('guessInputMulti');

            if (multiplayerMode === 'turn-based') {
                turnInfo.style.display = 'block';
                if (currentTurn === playerId) {
                    turnText.textContent = getText('yourTurn');
                    turnText.style.color = '#667eea';
                    guessBtn.disabled = false;
                    guessInput.disabled = false;
                } else {
                    turnText.textContent = getText('opponentTurn');
                    turnText.style.color = '#e74c3c';
                    guessBtn.disabled = true;
                    guessInput.disabled = true;
                }
            } else {
                turnInfo.style.display = 'none';
                guessBtn.disabled = false;
                guessInput.disabled = false;
            }
        }

        function makeGuessMulti() {
            if (gameEnded) return;

            // í„´ì œ ëª¨ë“œì¼ ê²½ìš° í˜„ì¬ í„´ ì²´í¬
            if (multiplayerMode === 'turn-based' && currentTurn !== playerId) {
                alert(getText('errorNotYourTurn'));
                return;
            }

            const input = document.getElementById('guessInputMulti');
            const guess = input.value.trim();

            if (guess.length !== 3 || !/^\d{3}$/.test(guess)) {
                alert(getText('errorDigits'));
                return;
            }

            if (new Set(guess).size !== 3) {
                alert(getText('errorRepeating'));
                return;
            }

            attempts++;
            const result = calculateResult(answer, guess);
            const resultStr = formatResult(result.strike, result.ball);

            addHistoryMulti(guess, resultStr);

            const roomRef = database.ref('rooms/' + roomCode + '/players/' + playerId);
            roomRef.update({ attempts: attempts });

            if (result.strike === 3) {
                roomRef.update({ isWinner: true });
            } else if (multiplayerMode === 'turn-based') {
                // í„´ì œ ëª¨ë“œì¼ ê²½ìš° í„´ êµì²´
                switchTurn();
            }

            input.value = '';
            input.focus();
        }

        function switchTurn() {
            const roomRef = database.ref('rooms/' + roomCode);
            roomRef.child('turnOrder').once('value').then(snapshot => {
                const turnOrder = snapshot.val() || [];
                const currentIndex = turnOrder.indexOf(currentTurn);
                const nextIndex = (currentIndex + 1) % turnOrder.length;
                const nextTurn = turnOrder[nextIndex];
                roomRef.update({ currentTurn: nextTurn });
            });
        }

        function addHistoryMulti(guess, result) {
            const historyEl = document.getElementById('historyMulti');
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <span class="guess-number">${guess}</span>
                <span class="result">${result}</span>
            `;
            historyEl.insertBefore(item, historyEl.firstChild);
        }

        function showMultiResult(won, myAttempts, opponentAttempts) {
            const modal = document.getElementById('resultModal');
            const emoji = document.getElementById('resultEmoji');
            const text = document.getElementById('resultText');
            const detail = document.getElementById('resultDetail');

            if (won) {
                emoji.textContent = 'ğŸ‰';
                text.textContent = getText('winTitle');
                detail.textContent = getText('winDetail', { attempts: myAttempts });
            } else {
                emoji.textContent = 'ğŸ˜¢';
                text.textContent = getText('loseTitle');
                detail.textContent = getText('loseDetail', { attempts: opponentAttempts });
            }

            // ë©€í‹°í”Œë ˆì´ì–´ ë²„íŠ¼ í‘œì‹œ, í˜¼ìí•˜ê¸° ë²„íŠ¼ ìˆ¨ê¹€
            document.getElementById('multiplayerButtons').style.display = 'block';
            document.getElementById('soloButton').style.display = 'none';

            modal.classList.add('show');
        }

        function showSoloResult(won) {
            const modal = document.getElementById('resultModal');
            const emoji = document.getElementById('resultEmoji');
            const text = document.getElementById('resultText');
            const detail = document.getElementById('resultDetail');

            if (won) {
                emoji.textContent = 'ğŸ‰';
                text.textContent = getText('soloWinTitle');
                detail.textContent = getText('soloWinDetail', { attempts: attempts, answer: answer });
            } else {
                emoji.textContent = 'ğŸ˜¢';
                text.textContent = getText('soloLoseTitle');
                detail.textContent = getText('soloLoseDetail', { answer: answer });
            }

            // í˜¼ìí•˜ê¸° ë²„íŠ¼ í‘œì‹œ, ë©€í‹°í”Œë ˆì´ì–´ ë²„íŠ¼ ìˆ¨ê¹€
            document.getElementById('multiplayerButtons').style.display = 'none';
            document.getElementById('soloButton').style.display = 'block';

            modal.classList.add('show');
        }

        function playAgain() {
            // ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('resultModal').classList.remove('show');
            
            // ìƒˆ ê²Œì„ ì‹œì‘
            answer = generateNumber();
            attempts = 0;
            gameEnded = false;

            // Firebase ì—…ë°ì´íŠ¸
            const roomRef = database.ref('rooms/' + roomCode);
            roomRef.update({
                answer: answer,
                currentTurn: multiplayerMode === 'turn-based' ? (isHost ? playerId : opponentId) : null
            });

            // í”Œë ˆì´ì–´ ë°ì´í„° ë¦¬ì…‹
            const playerRef = roomRef.child('players/' + playerId);
            playerRef.update({
                attempts: 0,
                isWinner: false
            });

            // UI ë¦¬ì…‹
            document.getElementById('myAttempts').textContent = '0';
            document.getElementById('opponentAttempts').textContent = '0';
            document.getElementById('myStatus').textContent = getText('myStatusPlaying');
            document.getElementById('opponentStatus').textContent = getText('opponentStatusPlaying');
            document.getElementById('historyMulti').innerHTML = '';
            document.getElementById('guessInputMulti').value = '';
            
            if (multiplayerMode === 'turn-based') {
                updateTurnDisplay();
            }

            document.getElementById('guessInputMulti').focus();
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(roomCode).then(() => {
                alert(getText('codeCopied') + roomCode);
            });
        }

        function shareRoomCode() {
            const text = getText('shareMessage', { 
                code: roomCode, 
                url: window.location.href.split('?')[0]
            });
            
            if (navigator.share) {
                navigator.share({
                    title: getText('mainTitle'),
                    text: text
                });
            } else {
                copyRoomCode();
            }
        }

        function leaveRoom() {
            if (roomCode) {
                database.ref('rooms/' + roomCode + '/players/' + playerId).remove();
            }
            backToMode();
        }

        function closeModal() {
            document.getElementById('resultModal').classList.remove('show');
            if (gameMode === 'multiplayer') {
                leaveRoom();
            } else {
                backToMode();
            }
        }

        function backToMode() {
            roomCode = '';
            isHost = false;
            answer = '';
            attempts = 0;
            gameEnded = false;
            gameMode = '';
            multiplayerMode = '';
            currentTurn = '';
            opponentId = '';

            document.getElementById('historyMulti').innerHTML = '';
            document.getElementById('historySolo').innerHTML = '';
            document.getElementById('guessInputMulti').value = '';
            document.getElementById('guessInputSolo').value = '';
            document.getElementById('resultModal').classList.remove('show');
            
            hideAllSections();
            document.getElementById('modeSelector').style.display = 'block';
        }

        function hideAllSections() {
            document.getElementById('languageSelector').style.display = 'none';
            document.getElementById('modeSelector').style.display = 'none';
            document.getElementById('gameModeSelection').style.display = 'none';
            document.getElementById('joinSection').style.display = 'none';
            document.getElementById('waitingRoom').style.display = 'none';
            document.getElementById('multiplayerGame').style.display = 'none';
            document.getElementById('soloGame').style.display = 'none';
        }

        // URLì—ì„œ ë°© ì½”ë“œ í™•ì¸
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const roomParam = params.get('room');
            if (roomParam) {
                setLanguage('ko'); // ê¸°ë³¸ ì–¸ì–´ë¡œ ì‹œì‘
                document.getElementById('roomCodeInput').value = roomParam;
                showJoinRoom();
            }
        });

        // Enter í‚¤ ì§€ì›
        document.getElementById('guessInputMulti').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') makeGuessMulti();
        });

        document.getElementById('guessInputSolo').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') makeGuessSolo();
        });

        document.getElementById('roomCodeInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinRoom();
        });
    </script>
</body>
</html>
